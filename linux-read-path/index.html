<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Read syscall implementation in Linux Kernel - Xing Lin</title><meta name="Description" content="Read path in the Linux kernel"><meta property="og:title" content="Read syscall implementation in Linux Kernel" />
<meta property="og:description" content="Read path in the Linux kernel" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xinglin.github.io/linux-read-path/" /><meta property="og:image" content="https://xinglin.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-28T11:36:16-07:00" /><meta property="og:site_name" content="Xing Lin" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://xinglin.github.io/logo.png"/>

<meta name="twitter:title" content="Read syscall implementation in Linux Kernel"/>
<meta name="twitter:description" content="Read path in the Linux kernel"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://xinglin.github.io/linux-read-path/" /><link rel="prev" href="https://xinglin.github.io/reinvent2018-tidbits/" /><link rel="next" href="https://xinglin.github.io/making-databases-work/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Read syscall implementation in Linux Kernel",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/xinglin.github.io\/linux-read-path\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/xinglin.github.io\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "engineering, linux, source code","wordcount":  1214 ,
        "url": "https:\/\/xinglin.github.io\/linux-read-path\/","datePublished": "2019-01-16T00:00:00+00:00","dateModified": "2022-05-28T11:36:16-07:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/xinglin.github.io\/images\/avatar.png",
                    "width":  528 ,
                    "height":  560 
                }},"author": {
                "@type": "Person",
                "name": "Xing Lin"
            },"description": "Read path in the Linux kernel"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Xing Lin">Hello, World</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/publications/"> Publications </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/xinglin" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Xing Lin">Hello, World</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/publications/" title="">Publications</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/xinglin" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw' aria-hidden='true'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Read syscall implementation in Linux Kernel</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Xing Lin</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2019-01-16">2019-01-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1214 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#interactions-among-vfs-page-cache-and-ext2-on-serving-a-read-request">Interactions among vfs, page cache, and ext2 on serving a read request</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="interactions-among-vfs-page-cache-and-ext2-on-serving-a-read-request">Interactions among vfs, page cache, and ext2 on serving a read request</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="../sysread.png"
        data-srcset="../sysread.png, ../sysread.png 1.5x, ../sysread.png 2x"
        data-sizes="auto"
        alt="../sysread.png"
        title="../sysread.png" /></p>
<h1 id="stack-trace-for-ext2_readpages-in-ext2">stack trace for ext2_readpages() in ext2</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[   84.037457] Call Trace:
</span></span><span class="line"><span class="cl">[   84.037458]  dump_stack+0x46/0x5b
</span></span><span class="line"><span class="cl">[   84.037460]  ext2_readpages+0x3e/0x90
</span></span><span class="line"><span class="cl">[   84.037464]  read_pages+0x71/0x1a0
</span></span><span class="line"><span class="cl">[   84.037470]  ? __do_page_cache_readahead+0x1c9/0x1e0
</span></span><span class="line"><span class="cl">[   84.037472]  __do_page_cache_readahead+0x1c9/0x1e0
</span></span><span class="line"><span class="cl">[   84.037474]  ondemand_readahead+0x171/0x2b0
</span></span><span class="line"><span class="cl">[   84.037478]  ? pagecache_get_page+0x30/0x2c0
</span></span><span class="line"><span class="cl">[   84.037481]  ? __kernel_text_address+0xe/0x30
</span></span><span class="line"><span class="cl">[   84.037483]  generic_file_read_iter+0x875/0xda0
</span></span><span class="line"><span class="cl">[   84.037412]  ext2_file_read_iter+0x4c/0xe0
</span></span><span class="line"><span class="cl">[   84.037488]  new_sync_read+0x12e/0x1d0
</span></span><span class="line"><span class="cl">[   84.037490]  vfs_read+0x91/0x130
</span></span><span class="line"><span class="cl">[   84.037492]  ksys_read+0x52/0xc0
</span></span><span class="line"><span class="cl">[   84.037494]  do_syscall_64+0x4f/0x100
</span></span><span class="line"><span class="cl">[   84.037496]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[   84.037379] Call Trace:
</span></span><span class="line"><span class="cl">[   84.037405]  dump_stack+0x46/0x5b
</span></span><span class="line"><span class="cl">[   84.037412]  ext2_file_read_iter+0x4c/0xe0
</span></span><span class="line"><span class="cl">[   84.037419]  new_sync_read+0x12e/0x1d0
</span></span><span class="line"><span class="cl">[   84.037426]  vfs_read+0x91/0x130
</span></span><span class="line"><span class="cl">[   84.037428]  ksys_read+0x52/0xc0
</span></span><span class="line"><span class="cl">[   84.037431]  do_syscall_64+0x4f/0x100
</span></span><span class="line"><span class="cl">[   84.037438]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="readwrite-syscall-definitions">read/write syscall definitions</h1>
<p>read/write syscalls are defined in fs/read_write.c, as following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">unsigned</span> <span class="ne">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">unsigned</span> <span class="ne">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="n">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ksys_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="read-syscall-call-stack">Read syscall call stack</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">vfs_read</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">__vfs_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">new_sync_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">Take</span> <span class="n">ext2</span> <span class="n">as</span> <span class="n">an</span> <span class="n">example</span><span class="o">.</span> <span class="n">ext2</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">define</span> <span class="n">read</span><span class="p">()</span> <span class="n">but</span> <span class="n">defines</span> <span class="n">read_iter</span><span class="p">()</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">struct</span> <span class="n">file_operations</span> <span class="n">ext2_file_operations</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">read_iter</span>	<span class="o">=</span> <span class="n">ext2_file_read_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">write_iter</span>	<span class="o">=</span> <span class="n">ext2_file_write_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">ext2_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef CONFIG_COMPAT</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">ext2_compat_ioctl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">ext2_file_mmap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dquot_file_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">ext2_release_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">fsync</span>		<span class="o">=</span> <span class="n">ext2_fsync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">get_unmapped_area</span> <span class="o">=</span> <span class="n">thp_get_unmapped_area</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">splice_read</span>	<span class="o">=</span> <span class="n">generic_file_splice_read</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">splice_write</span>	<span class="o">=</span> <span class="n">iter_file_splice_write</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">new_sync_read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">call_read_iter</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kiocb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">(</span><span class="n">kio</span><span class="p">,</span> <span class="n">iter</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="ext2_file_read_iter">ext2_file_read_iter()</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ext2_file_read_iter</span><span class="p">():</span> <span class="n">ext2_file_operations</span><span class="o">.</span><span class="n">read_iter</span>
</span></span><span class="line"><span class="cl">  <span class="n">generic_file_read_iter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">generic_file_buffered_read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">find_get_page</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">page_cache_sync_readahead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="ow">or</span> <span class="n">page_cache_async_readahead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ondemand_readahead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="n">__do_page_cache_readahead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">read_pages</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">              <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpages</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="ow">or</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpage</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">ext2</span> <span class="n">defines</span> <span class="n">both</span> <span class="n">readpage</span><span class="p">()</span> <span class="ow">and</span> <span class="n">readpages</span><span class="p">()</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">struct</span> <span class="n">address_space_operations</span> <span class="n">ext2_aops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">readpage</span>		<span class="o">=</span> <span class="n">ext2_readpage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">readpages</span>		<span class="o">=</span> <span class="n">ext2_readpages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">writepage</span>		<span class="o">=</span> <span class="n">ext2_writepage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">write_begin</span>		<span class="o">=</span> <span class="n">ext2_write_begin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">write_end</span>		<span class="o">=</span> <span class="n">ext2_write_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">bmap</span>			<span class="o">=</span> <span class="n">ext2_bmap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">direct_IO</span>		<span class="o">=</span> <span class="n">ext2_direct_IO</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">writepages</span>		<span class="o">=</span> <span class="n">ext2_writepages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">migratepage</span>		<span class="o">=</span> <span class="n">buffer_migrate_page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">is_partially_uptodate</span>	<span class="o">=</span> <span class="n">block_is_partially_uptodate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="n">error_remove_page</span>	<span class="o">=</span> <span class="n">generic_error_remove_page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span> <span class="n">The</span> <span class="n">IO</span> <span class="n">request</span> <span class="n">is</span> <span class="n">submitted</span> <span class="n">to</span> <span class="n">the</span> <span class="n">block</span> <span class="n">layer</span> <span class="n">by</span> <span class="n">calling</span> <span class="n">mpage_bio_submit</span><span class="p">()</span><span class="o">.</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">ext2_readpages</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">mpage_readpages</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">mpage_bio_submit</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">__do_page_cache_readahead</span><span class="p">()</span> <span class="n">actually</span> <span class="n">reads</span> <span class="n">a</span> <span class="n">chunk</span> <span class="n">of</span> <span class="n">disk</span><span class="o">.</span>  <span class="n">It</span> <span class="n">allocates</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">the</span> <span class="n">pages</span> <span class="n">first</span><span class="p">,</span> <span class="n">then</span> <span class="n">submits</span> <span class="n">them</span> <span class="k">for</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span><span class="o">.</span> <span class="n">This</span> <span class="n">avoids</span> <span class="n">the</span> <span class="n">very</span> <span class="n">bad</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">behaviour</span> <span class="n">which</span> <span class="n">would</span> <span class="n">occur</span> <span class="k">if</span> <span class="n">page</span> <span class="n">allocations</span> <span class="n">are</span> <span class="n">causing</span> <span class="n">VM</span> <span class="n">writeback</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">We</span> <span class="n">really</span> <span class="n">don</span><span class="s1">&#39;t want to intermingle reads and writes like that.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Returns</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">pages</span> <span class="n">requested</span><span class="p">,</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">allowed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">unsigned</span> <span class="ne">int</span> <span class="n">__do_page_cache_readahead</span><span class="p">(</span><span class="n">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">pgoff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">nr_to_read</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">unsigned</span> <span class="n">long</span> <span class="n">lookahead_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">Preallocate</span> <span class="n">as</span> <span class="n">many</span> <span class="n">pages</span> <span class="n">as</span> <span class="n">we</span> <span class="n">will</span> <span class="n">need</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="n">nr_to_read</span><span class="p">;</span> <span class="n">page_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pgoff_t</span> <span class="n">page_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">page_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">page_offset</span> <span class="o">&gt;</span> <span class="n">end_index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">page</span> <span class="o">=</span> <span class="n">xa_load</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">i_pages</span><span class="p">,</span> <span class="n">page_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xa_is_value</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">/*</span>
</span></span><span class="line"><span class="cl">			 <span class="o">*</span> <span class="n">Page</span> <span class="n">already</span> <span class="n">present</span><span class="err">?</span>  <span class="n">Kick</span> <span class="n">off</span> <span class="n">the</span> <span class="n">current</span> <span class="n">batch</span> <span class="n">of</span>
</span></span><span class="line"><span class="cl">			 <span class="o">*</span> <span class="n">contiguous</span> <span class="n">pages</span> <span class="n">before</span> <span class="n">continuing</span> <span class="n">with</span> <span class="n">the</span> <span class="n">next</span>
</span></span><span class="line"><span class="cl">			 <span class="o">*</span> <span class="n">batch</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">			 <span class="o">*/</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">read_pages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_pool</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">gfp_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">nr_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">page</span> <span class="o">=</span> <span class="n">__page_cache_alloc</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">page_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_pool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">==</span> <span class="n">nr_to_read</span> <span class="o">-</span> <span class="n">lookahead_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">SetPageReadahead</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">nr_pages</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">Now</span> <span class="n">start</span> <span class="n">the</span> <span class="n">IO</span><span class="o">.</span>  <span class="n">We</span> <span class="n">ignore</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">errors</span> <span class="o">-</span> <span class="k">if</span> <span class="n">the</span> <span class="n">page</span> <span class="n">is</span> <span class="ow">not</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">uptodate</span> <span class="n">then</span> <span class="n">the</span> <span class="n">caller</span> <span class="n">will</span> <span class="n">launch</span> <span class="n">readpage</span> <span class="n">again</span><span class="p">,</span> <span class="ow">and</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">will</span> <span class="n">then</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">error</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">nr_pages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">read_pages</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_pool</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="ne">int</span> <span class="n">read_pages</span><span class="p">(</span><span class="n">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span> <span class="n">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pages</span><span class="p">,</span> <span class="n">unsigned</span> <span class="ne">int</span> <span class="n">nr_pages</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">blk_plug</span> <span class="n">plug</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">page_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="ne">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">blk_start_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpages</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">nr_pages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">/*</span> <span class="n">Clean</span> <span class="n">up</span> <span class="n">the</span> <span class="n">remaining</span> <span class="n">pages</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">		<span class="n">put_pages_list</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="n">nr_pages</span><span class="p">;</span> <span class="n">page_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">lru_to_page</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">lru</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">add_to_page_cache_lru</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">gfp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">a_ops</span><span class="o">-&gt;</span><span class="n">readpage</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">put_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">blk_finish_plug</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plug</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="io-path-from-understanding-the-linux-kernel">IO Path from Understanding the Linux Kernel</h1>
<p>The following explanation is from the book, Understanding the Linux Kernel. It seems that the implementions of Linux VFS and specific filesystems have evolved that the explanation from the book is not accurate.</p>
<p>In Linux, when a file is opened by a process, its file object will be added to the process control block (struct task_struct). The process control block has a pointer, struct files_struct* files, to keep track of all opened files. Within the files_struct, there exists struct fdtable, storing file objects for all file descriptors. A file descriptor is an index into this file object array of type struct file. Each file object (struct file) has a pointer to a file operations object (struct file_operations), to invoke file system specific operations for that file.</p>
<p>When a read() is called from the process for a file descriptor, it will invoke the sys_read(), which calls the read() operation for that file object (file-&gt;f_op-&gt;read(&hellip;)).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">task_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="o">/*</span> <span class="n">Open</span> <span class="n">file</span> <span class="n">information</span><span class="p">:</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">files_struct</span>		<span class="o">*</span><span class="n">files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/*</span>
</span></span><span class="line"><span class="cl"> <span class="o">*</span> <span class="n">Open</span> <span class="n">file</span> <span class="n">table</span> <span class="n">structure</span>
</span></span><span class="line"><span class="cl"> <span class="o">*/</span>
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">files_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span>
</span></span><span class="line"><span class="cl">   <span class="o">*</span> <span class="n">read</span> <span class="n">mostly</span> <span class="n">part</span>
</span></span><span class="line"><span class="cl">   <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">atomic_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="ne">bool</span> <span class="n">resize_in_progress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">wait_queue_head_t</span> <span class="n">resize_wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">fdtable</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">fdtable</span> <span class="n">fdtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">/*</span>
</span></span><span class="line"><span class="cl">   <span class="o">*</span> <span class="n">written</span> <span class="n">part</span> <span class="n">on</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">cache</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">SMP</span>
</span></span><span class="line"><span class="cl">   <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">spinlock_t</span> <span class="n">file_lock</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> <span class="n">next_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="n">close_on_exec_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="n">open_fds_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="n">full_fds_bits_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">file</span> <span class="n">__rcu</span> <span class="o">*</span> <span class="n">fd_array</span><span class="p">[</span><span class="n">NR_OPEN_DEFAULT</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">fdtable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> <span class="n">max_fds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">file</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">fd</span><span class="p">;</span>      <span class="o">/*</span> <span class="n">current</span> <span class="n">fd</span> <span class="n">array</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="o">*</span><span class="n">close_on_exec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="o">*</span><span class="n">open_fds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="n">long</span> <span class="o">*</span><span class="n">full_fds_bits</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">struct</span> <span class="n">file</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">struct</span> <span class="n">llist_node</span>	<span class="n">fu_llist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">struct</span> <span class="n">rcu_head</span> 	<span class="n">fu_rcuhead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">f_u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">path</span>		<span class="n">f_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">inode</span>		<span class="o">*</span><span class="n">f_inode</span><span class="p">;</span>	<span class="o">/*</span> <span class="n">cached</span> <span class="n">value</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">struct</span> <span class="n">file_operations</span>	<span class="o">*</span><span class="n">f_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">/*</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">Protects</span> <span class="n">f_ep_links</span><span class="p">,</span> <span class="n">f_flags</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*</span> <span class="n">Must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">taken</span> <span class="n">from</span> <span class="n">IRQ</span> <span class="n">context</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">	 <span class="o">*/</span>
</span></span><span class="line"><span class="cl">	<span class="n">spinlock_t</span>		<span class="n">f_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">enum</span> <span class="n">rw_hint</span>		<span class="n">f_write_hint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">atomic_long_t</span>		<span class="n">f_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">unsigned</span> <span class="ne">int</span> 		<span class="n">f_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">fmode_t</span>			<span class="n">f_mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">mutex</span>		<span class="n">f_pos_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">loff_t</span>			<span class="n">f_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">fown_struct</span>	<span class="n">f_owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">struct</span> <span class="n">cred</span>	<span class="o">*</span><span class="n">f_cred</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">struct</span> <span class="n">file_ra_state</span>	<span class="n">f_ra</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">__randomize_layout</span>
</span></span><span class="line"><span class="cl">  <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>	<span class="o">/*</span> <span class="n">lest</span> <span class="n">something</span> <span class="n">weird</span> <span class="n">decides</span> <span class="n">that</span> <span class="mi">2</span> <span class="n">is</span> <span class="n">OK</span> <span class="o">*/</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-05-28</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/linux-read-path/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://xinglin.github.io/linux-read-path/" data-title="Read syscall implementation in Linux Kernel" data-hashtags="engineering,linux,source code"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://xinglin.github.io/linux-read-path/" data-hashtag="engineering"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://xinglin.github.io/linux-read-path/" data-title="Read syscall implementation in Linux Kernel"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://xinglin.github.io/linux-read-path/" data-title="Read syscall implementation in Linux Kernel"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://xinglin.github.io/linux-read-path/" data-title="Read syscall implementation in Linux Kernel"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/engineering/">engineering</a>,&nbsp;<a href="/tags/linux/">linux</a>,&nbsp;<a href="/tags/source-code/">source code</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/reinvent2018-tidbits/" class="prev" rel="prev" title="AWS re:Invent 2018 tidbits"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>AWS re:Invent 2018 tidbits</a>
            <a href="/making-databases-work/" class="next" rel="next" title="Wisdom from Michael Stonebraker">Wisdom from Michael Stonebraker<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.120.4">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Xing Lin</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
